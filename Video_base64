import os
from pathlib import Path
import urllib.request
import subprocess

print("üì• Setting up model checkpoints...")

CHECKPOINT_DIR = os.path.join(BASE_DIR, "checkpoints")
os.makedirs(CHECKPOINT_DIR, exist_ok=True)

# Download Wav2Lip checkpoint (652MB)
WAV2LIP_CHECKPOINT = os.path.join(CHECKPOINT_DIR, "wav2lip.pth")

if not os.path.exists(WAV2LIP_CHECKPOINT):
    print("‚è≥ Downloading Wav2Lip model (652MB - may take 2-5 minutes)...")
    
    checkpoint_url = "https://github.com/Rudrabha/Wav2Lip/releases/download/initial_release/checkpoints_v3.zip"
    
    # Download zip file
    zip_path = os.path.join(CHECKPOINT_DIR, "checkpoints_v3.zip")
    try:
        urllib.request.urlretrieve(checkpoint_url, zip_path)
        print("‚úÖ Downloaded successfully")
        
        # Extract
        import zipfile
        with zipfile.ZipFile(zip_path, 'r') as zip_ref:
            zip_ref.extractall(CHECKPOINT_DIR)
        
        os.remove(zip_path)
        print("‚úÖ Extracted checkpoints")
    except Exception as e:
        print(f"‚ö†Ô∏è Download failed: {e}")
        print("üí° Alternative: Download manually from https://github.com/Rudrabha/Wav2Lip/releases")
else:
    print("‚úÖ Checkpoint already exists")

# Download face detection model (dlib)
print("üì• Downloading face detection model...")
FACE_DET_CHECKPOINT = os.path.join(CHECKPOINT_DIR, "mmod_human_face_detector.dat")

if not os.path.exists(FACE_DET_CHECKPOINT):
    face_det_url = "http://dlib.net/files/mmod_human_face_detector.dat.bz2"
    try:
        bz2_path = os.path.join(CHECKPOINT_DIR, "mmod_human_face_detector.dat.bz2")
        urllib.request.urlretrieve(face_det_url, bz2_path)
        
        import bz2
        with bz2.open(bz2_path, 'rb') as f_in:
            with open(FACE_DET_CHECKPOINT, 'wb') as f_out:
                shutil.copyfileobj(f_in, f_out)
        
        os.remove(bz2_path)
        print("‚úÖ Face detection model downloaded")
    except Exception as e:
        print(f"‚ö†Ô∏è Face detection download failed: {e}")
        print("üí° Will try to use MediaPipe as fallback")
else:
    print("‚úÖ Face detection model already exists")

print("‚úÖ Model Weights Setup Complete!")
