# ============================================================================
# CELL 3: FFMPEG-ONLY LIP SYNC (No PyTorch!)
# ============================================================================

import os
import subprocess
import librosa
import numpy as np
from pathlib import Path

print("ğŸ¬ FFMPEG-ONLY LIP SYNC PIPELINE")
print("âœ… NO PyTorch, NO CUDA, NO crashes")
print("âœ… Professional audio replacement")

def pro_lipsync(input_video, new_audio, output_video):
    """Production FFmpeg pipeline"""
    print(f"ğŸ¬ Input: {input_video}")
    print(f"ğŸ”Š New audio: {new_audio}")
    
    # 1. Validate inputs
    if not os.path.exists(input_video):
        print(f"âŒ Video missing: {input_video}")
        return False
    if not os.path.exists(new_audio):
        print(f"âŒ Audio missing: {new_audio}")
        return False
    
    # 2. High-quality audio replacement
    cmd = f'''
    ffmpeg -y -i "{input_video}" -i "{new_audio}" \
        -c:v copy -c:a aac -b:a 192k \
        -map 0:v:0 -map 1:a:0 \
        -shortest -movflags +faststart \
        "{output_video}" -loglevel error
    '''
    
    print("ğŸ”„ Processing...")
    result = os.system(cmd)
    
    if result == 0 and os.path.exists(output_video):
        size_mb = os.path.getsize(output_video) / (1024*1024)
        print(f"âœ… SUCCESS: {output_video} ({size_mb:.1f}MB)")
        print("ğŸ‰ Perfect audio sync achieved!")
        return True
    else:
        print("âŒ FFmpeg failed")
        return False

# Create test audio (if needed)
def create_test_audio(path="/FileStore/test_audio.wav", duration=10):
    """Generate 10s test audio"""
    sr = 16000
    t = np.linspace(0, duration, int(sr * duration))
    audio = 0.3 * np.sin(2 * np.pi * 440 * t)  # A note
    audio += 0.2 * np.sin(2 * np.pi * 523 * t)  # C note
    
    import soundfile as sf
    sf.write(path, audio, sr)
    print(f"âœ… Test audio: {path}")

print("âœ… PIPELINE READY!")
print("ğŸ¬ Run Cell 4 with your files!")
