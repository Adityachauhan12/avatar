# ============================================================================
# CELL 4: LOAD WAV2LIP MODEL (FIXED IMPORTS)
# ============================================================================

print("ğŸ¤– Loading Wav2Lip model...")
print("ğŸ’» Checking GPU availability...")

# Safe torch import
device = "cpu"  # Force CPU first (safe)
try:
    import torch
    if torch.cuda.is_available():
        device = "cuda"
    print(f"âœ… Device: {device}")
except:
    device = "cpu"
    print("âš ï¸  CPU only")

# Verify BASE_DIR from Cell 1 exists
print(f"ğŸ“ BASE_DIR: {BASE_DIR}")
print(f"ğŸ“ Files in BASE_DIR: {os.listdir(BASE_DIR)}")

# CORRECT IMPORT PATHS (Rudrabha/Wav2Lip structure)
try:
    sys.path.insert(0, BASE_DIR)
    
    # Check what's actually in the models folder
    models_path = os.path.join(BASE_DIR, "models")
    if os.path.exists(models_path):
        print(f"ğŸ“ Models folder: {os.listdir(models_path)}")
    
    # Try direct imports (correct structure)
    from models import Wav2Lip  # â† NOT wav2lip.models
    print("âœ… Wav2Lip model class found!")
    
    # Load checkpoint
    checkpoint_path = f"{CHECKPOINT_DIR}/wav2lip.pth"
    if os.path.exists(checkpoint_path):
        checkpoint = torch.load(checkpoint_path, map_location=device)
        model = Wav2Lip()
        
        # Handle both checkpoint formats
        if 'state_dict' in checkpoint:
            model.load_state_dict(checkpoint['state_dict'])
        else:
            model.load_state_dict(checkpoint)
            
        model = model.to(device)
        model.eval()
        print(f"âœ… Model LOADED on {device}")
        print(f"ğŸ“Š {sum(p.numel() for p in model.parameters())/1e6:.1f}M params")
    else:
        print(f"âŒ Missing: {checkpoint_path}")
        print("ğŸ’¡ Download from Cell 2")
        
except ImportError as e:
    print(f"âŒ Import error: {e}")
    print("ğŸ“ Checking folder structure...")
    if os.path.exists(BASE_DIR):
        for root, dirs, files in os.walk(BASE_DIR):
            print(f"  {root}: {len(files)} files")
except Exception as e:
    print(f"âŒ Load error: {e}")
    model = None

print(f"\nğŸ¬ Status: {'âœ… READY' if 'model' in locals() and model else 'âš ï¸ PENDING'}")
