# CELL 8: Test Base64 Endpoint
import requests
import json
import base64
import os

# 1. Config
endpoint_name = "ditto_server_v2"
workspace_url = spark.conf.get("spark.databricks.workspaceUrl")
token = dbutils.notebook.entry_point.getDbutils().notebook().getContext().apiToken().get()
endpoint_url = f"https://{workspace_url}/serving-endpoints/{endpoint_name}/invocations"

# 2. Your Files (Unity Catalog Paths)
audio_file = "/Volumes/lab37_catalog/ifstrolley/trolley/Thank you for bookin (1).wav"
image_file = "/Volumes/lab37_catalog/ifstrolley/trolley/new.png"
output_file = "/Volumes/lab37_catalog/ifstrolley/trolley/output_video.mp4"

print(f"üìÑ Reading files...")

# 3. Encode to Base64
with open(audio_file, "rb") as f:
    audio_b64 = base64.b64encode(f.read()).decode('utf-8')

with open(image_file, "rb") as f:
    image_b64 = base64.b64encode(f.read()).decode('utf-8')

# 4. Payload
payload = {
    "dataframe_split": {
        "columns": ["audio_b64", "image_b64"],
        "data": [[audio_b64, image_b64]]
    }
}

print(f"üöÄ Sending request to {endpoint_name}...")
headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}

try:
    response = requests.post(endpoint_url, json=payload, headers=headers)
    
    if response.status_code == 200:
        result = response.json()
        
        # Check success
        prediction = result['predictions'][0] if 'predictions' in result else result
        if isinstance(prediction, list): prediction = prediction[0] # Handle list wrapper
        
        if prediction.get('status') == 'success':
            video_b64 = prediction['video_b64']
            
            # 5. Decode & Save Video
            with open(output_file, "wb") as f:
                f.write(base64.b64decode(video_b64))
            print(f"‚úÖ SUCCESS! Video saved to: {output_file}")
        else:
            print(f"‚ùå Model Error: {prediction}")
    else:
        print(f"‚ùå HTTP Error {response.status_code}: {response.text}")

except Exception as e:
    print(f"üí• Exception: {e}")
