# CELL 5: Log & Register Model (Base64 + Full Dependencies)
import mlflow
from mlflow.models.signature import infer_signature
import pandas as pd
import git  # Check import exists

# 1. Configuration
mlflow.set_registry_uri("databricks-uc")
# Use a specific experiment path to avoid notebook location issues
mlflow.set_experiment("/Shared/ditto_experiment")

# 2. Define Signature (Base64 In -> Base64 Out)
# Using short dummy strings to define the schema
test_input = pd.DataFrame({
    "audio_b64": ["UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="], # Dummy WAV
    "image_b64": ["iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII="] # Dummy PNG
})

test_output = pd.DataFrame({
    "status": ["success"],
    "message": ["Video generated"],
    "video_b64": ["AAAAIGZ0eXBpc29tAAACAgAAAABpc29tcGF2YzFtcDQyAAAAAAA..."] # Dummy MP4 string
})

signature = infer_signature(test_input, test_output)

# 3. Define Dependencies (From your setup script)
# We pin versions to match your tested environment
reqs = [
    "gitpython==3.1.40",
    # Core DL/TensorRT stack
    "tensorrt==8.6.1",
    "tensorrt-libs==8.6.1",
    "tensorrt-bindings==8.6.1",
    "cuda-python==12.2.0",
    "onnxruntime-gpu==1.16.3",
    "numpy==1.26.4",        # Critical: Pinned to avoid 2.0+ conflicts
    
    # Audio/Video Processing
    "librosa>=0.10.1",
    "imageio-ffmpeg",       # Provides ffmpeg binary
    "opencv-python-headless", # Headless for server env
    "soundfile",
    "soxr",
    "imageio",
    "moviepy",

    # Ditto Specifics
    "mediapipe>=0.10.9",
    "ml_dtypes==0.4.0",
    "einops",
    "omegaconf",
    "huggingface_hub",
    "filetype",
    "tqdm",
    "scikit-image",
    "colored",
    "polygraphy",
    
    # Tensorflow (Warning: Huge package, remove if possible)
    "tensorflow" 
]

print("üì¶ Logging model with FULL dependency stack...")
print(f"   Dependencies: {len(reqs)} packages listed.")

with mlflow.start_run() as run:
    mlflow.pyfunc.log_model(
        artifact_path="ditto_talking_head",
        python_model=DittoTalkingHeadModel(), # Uses the class from CELL 4
        signature=signature,
        pip_requirements=reqs,  # Auto-installs these on endpoint
        conda_env=None
    )
    run_id = run.info.run_id

print(f"‚úÖ Model Logged. Run ID: {run_id}")

# 4. Register to Unity Catalog
# Replace with your exact catalog.schema.model_name
uc_model_name = "lab37_catalog.ifstrolley.ditto_talkinghead"

print(f"üìù Registering to {uc_model_name}...")

try:
    model_version = mlflow.register_model(
        model_uri=f"runs:/{run_id}/ditto_talking_head",
        name=uc_model_name
    )
    print(f"‚úÖ SUCCESS! Registered Version: {model_version.version}")
    print(f"üëâ ACTION REQUIRED: Go to Serving -> 'ditto_server_v2' -> Update to Version {model_version.version}")
    
except Exception as e:
    print(f"‚ùå Registration Error: {e}")
