# CELL 5: Log & Register Base64 Model
import mlflow
from mlflow.models.signature import infer_signature
import pandas as pd
import git  # Keep this import to verify it's available

mlflow.set_registry_uri("databricks-uc")
mlflow.set_experiment("/Shared/ditto_experiment")

# 1. Define Base64 Input/Output Signature
# We use short dummy strings to define the schema (string -> string)
test_input = pd.DataFrame({
    "audio_b64": ["UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="], # Dummy WAV
    "image_b64": ["iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII="] # Dummy PNG
})

test_output = pd.DataFrame({
    "status": ["success"],
    "message": ["Video generated"],
    "video_b64": ["AAAAIGZ0eXBpc29tAAACAgAAAABpc29tcGF2YzFtcDQyAAAAAAA..."] # Dummy MP4
})

signature = infer_signature(test_input, test_output)

print("üì¶ Packaging Base64 model with git...")

with mlflow.start_run():
    mlflow.pyfunc.log_model(
        artifact_path="ditto_talking_head",
        python_model=DittoTalkingHeadModel(),
        signature=signature,
        pip_requirements=["gitpython==3.1.40"],  # Critical: Packages git
        conda_env=None
    )
    run_id = mlflow.active_run().info.run_id

print(f"‚úÖ New run ID: {run_id}")

# 2. Register New Version
uc_model_name = "lab37_catalog.ifstrolley.ditto_talkinghead"

try:
    model_version = mlflow.register_model(
        model_uri=f"runs:/{run_id}/ditto_talking_head",
        name=uc_model_name
    )
    print(f"‚úÖ NEW VERSION REGISTERED: {model_version.version}")
    print(f"üëâ Go update your endpoint to Version {model_version.version} now!")
    
except Exception as e:
    print(f"‚ö†Ô∏è Registration warning: {e}")
