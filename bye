# CELL 10: Simplified Patch

import os

tensorrt_utils_path = "/tmp/ditto-model-artifact-patched/core/utils/tensorrt_utils.py"

print("ğŸ”§ Attempting patch with flexible patterns...")

with open(tensorrt_utils_path, "r") as f:
    content = f.read()

# Pattern 1: Just the assignment line
old1 = "self.engine = runtime.deserialize_cuda_engine(f.read())"

new1 = """try:
                    self.engine = runtime.deserialize_cuda_engine(f.read())
                except Exception as e:
                    if "Version tag does not match" in str(e) or "Serialization" in str(e):
                        print(f"âš ï¸ TensorRT engine format mismatch detected!")
                        self.engine = None
                    else:
                        raise"""

if old1 in content:
    print("âœ… Found Pattern 1!")
    content = content.replace(old1, new1)
    
    # Now find and replace the assert
    old_assert = "assert self.engine"
    new_assert = "assert self.engine, f\"Failed to load engine. Rebuild required.\""
    
    if old_assert in content:
        content = content.replace(old_assert, new_assert)
    
    with open(tensorrt_utils_path, "w") as f:
        f.write(content)
    
    print("âœ…âœ…âœ… PATCH APPLIED!")
else:
    print("âš ï¸ Pattern not found")
    lines = content.split('\n')
    for i, line in enumerate(lines):
        if "deserialize_cuda_engine" in line:
            print(f"\nFound deserialize at line {i+1}:")
            for j in range(max(0, i-2), min(len(lines), i+10)):
                print(f"{j+1:4d}: {lines[j]}")
            break
