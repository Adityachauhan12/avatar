# CELL 5: Log & Register Model (FIXED)
import mlflow
from mlflow.models.signature import infer_signature

# Set registry to Unity Catalog
mlflow.set_registry_uri("databricks-uc")

# FIX: Set experiment explicitly to avoid folder issues
mlflow.set_experiment("/Shared/ditto_experiment")

# Define input/output signature
test_input = pd.DataFrame({
    "audio_path": ["/path/to/audio.wav"],
    "image_path": ["/path/to/image.png"]
})

test_output = pd.DataFrame({
    "status": ["success"],
    "message": ["Video generated"],
    "video_path": ["/tmp/output.mp4"]
})

signature = infer_signature(test_input, test_output)

print("üìù Logging model...")

with mlflow.start_run() as run:
    mlflow.pyfunc.log_model(
        artifact_path="ditto_talking_head",
        python_model=DittoTalkingHeadModel(),
        signature=signature,
        conda_env={
            "channels": ["conda-forge"],
            "dependencies": ["python=3.10", "pip", {"pip": ["mlflow"]}],
            "name": "ditto-env"
        }
    )
    run_id = run.info.run_id

print(f"‚úÖ Model logged. Run ID: {run_id}")

# Register in Unity Catalog
uc_path = "harnayan.eng.ditto_talkinghead"

try:
    model_version = mlflow.register_model(
        model_uri=f"runs:/{run_id}/ditto_talking_head",
        name=uc_path
    )
    print(f"‚úÖ Registered: {uc_path}")
    print(f"   Version: {model_version.version}")
except Exception as e:
    print(f"‚ö†Ô∏è Note: {e}")
