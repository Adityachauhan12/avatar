# CELL 2: Clone Repository & Apply Patches
print("=" * 60)
print("üìÇ Setting Up Ditto Repository")
print("=" * 60)

import os
import git
import shutil

# Define paths
REPO_DIR = "/tmp/ditto-talkinghead-pytorch"
GITHUB_URL = "https://github.com/antgroup/ditto-talkinghead.git"

# Clean up if exists
if os.path.exists(REPO_DIR):
    print(f"üßπ Removing existing repo at {REPO_DIR}...")
    shutil.rmtree(REPO_DIR)

# Clone repository
print(f"üì• Cloning repository from {GITHUB_URL}...")
try:
    repo = git.Repo.clone_from(GITHUB_URL, REPO_DIR, depth=1, branch="main")
    print("‚úÖ Repository cloned successfully")
except Exception as e:
    print(f"‚ùå Failed to clone: {e}")
    raise

# Apply np.atan2 fix
print("\nüîß Applying code patches...")
patch_file = os.path.join(REPO_DIR, "core/aux_models/mediapipe_landmark478.py")
if os.path.exists(patch_file):
    print(f"   Patching {os.path.basename(patch_file)}...")
    with open(patch_file, "r") as f:
        content = f.read()
    if "np.atan2" in content:
        with open(patch_file, "w") as f:
            f.write(content.replace("np.atan2", "np.arctan2"))
        print("   ‚úÖ np.atan2 ‚Üí np.arctan2 patch applied")
    else:
        print("   ‚ÑπÔ∏è Patch not needed (already fixed)")
else:
    print(f"   ‚ö†Ô∏è Patch file not found: {patch_file}")

# Add to Python path
sys.path.insert(0, REPO_DIR)
os.chdir(REPO_DIR)

print(f"\n‚úÖ Repository ready at: {REPO_DIR}")
print(f"   Files: {len(os.listdir(REPO_DIR))} items")
