import os
import sys
import yaml
import subprocess

# --- 1. SETUP PATHS (YOUR FILES) ---
musetalk_root = "/dbfs/FileStore/MuseTalk"
output_dir = "/Volumes/lab37_catalog/ifstrolley/trolley/musetalk_output"
os.makedirs(output_dir, exist_ok=True)

# YOUR INPUT FILES
my_video_path = "/Volumes/lab37_catalog/ifstrolley/trolley/indigo_airhostress_response_v2.mp4"
my_audio_path = "/Volumes/lab37_catalog/ifstrolley/trolley/Thank you for bookin (1).wav"

print(f"üé¨ Video: {my_video_path}")
print(f"üéôÔ∏è Audio: {my_audio_path}")
print(f"üìÇ Output: {output_dir}")

# --- 2. GENERATE CONFIG FILE ---
# This ensures the inference script knows exactly which files to use
config = {
    "task_0": {
        "video_path": my_video_path,
        "audio_path": my_audio_path,
        "bbox_shift": 0
    }
}

config_path = f"{musetalk_root}/configs/inference/my_inference.yaml"
with open(config_path, "w") as f:
    yaml.dump(config, f)
print(f"‚úì Configuration file updated at: {config_path}")

# --- 3. GENERATE SELF-HEALING SCRIPT (V3) ---
# Includes: Flash Attn Mask + Diffusers 0.27.2 Downgrade + PyTorch Patch
with open(f"{musetalk_root}/scripts/inference.py", "r") as f:
    original_code = f.read()

header_code = """
import sys
import os
import subprocess

# 1. DISABLE BROKEN FLASH ATTENTION
sys.modules["flash_attn"] = None

# 2. AUTO-INSTALL/FIX DEPENDENCIES
def install(package):
    try: __import__(package)
    except ImportError:
        print(f"üì¶ Installing {package}...")
        subprocess.check_call([sys.executable, "-m", "pip", "install", package])

# Critical Downgrade for T4 compatibility
try:
    import diffusers
    # Check if version is too new (0.29+ breaks with old Accelerate)
    if int(diffusers.__version__.split('.')[1]) > 28:
        print("‚ö†Ô∏è Diffusers too new. Downgrading to 0.27.2...")
        subprocess.check_call([sys.executable, "-m", "pip", "install", "diffusers==0.27.2"])
except ImportError:
    subprocess.check_call([sys.executable, "-m", "pip", "install", "diffusers==0.27.2"])

install("transformers") # 4.39.2 ideally
install("accelerate")   # 0.28.0 ideally
install("omegaconf")
install("tensorboardX")
install("ffmpeg-python")
install("lpips")
install("facexlib")

# 3. MONKEY PATCH PYTORCH 2.0.1
import torch
if not hasattr(torch.library, 'impl_abstract'):
    def impl_abstract(qualname, func=None, *, lib=None, _stacklevel=1):
        def decorator(f): return f
        if func is not None: return decorator(func)
        return decorator
    torch.library.impl_abstract = impl_abstract

sys.path.append(os.getcwd())
"""

script_v3_path = f"{musetalk_root}/scripts/inference_final_v3.py"
with open(script_v3_path, "w") as f:
    f.write(header_code + original_code)
print(f"‚úì Inference script updated: {script_v3_path}")

# --- 4. EXECUTE INFERENCE ---
cmd = [
    sys.executable, "-m", "scripts.inference_final_v3",
    "--inference_config", config_path,
    "--result_dir", output_dir,
    "--unet_model_path", "./models/musetalk/pytorch_model.bin",
    "--unet_config", "./models/musetalk/musetalk.json",
    "--use_float16"
]

os.chdir(musetalk_root)
print(f"üöÄ Starting MuseTalk processing...")
process = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)

# Stream output
for line in process.stdout:
    print(line, end="")

process.wait()

if process.returncode == 0:
    print(f"\n‚úÖ SUCCESS! Video saved to: {output_dir}")
else:
    print(f"\n‚ùå FAILED with code {process.returncode}")
