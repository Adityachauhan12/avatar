# ditto_inference_wrapper.py logic inside a Databricks cell

import subprocess
from pathlib import Path
import uuid
import tempfile
import os

# Base repo path (you already cd here in the notebook)
/*
%cd /tmp/ditto-talkinghead
*/
DITTO_ROOT = Path("/tmp/ditto-talkinghead")
CHECKPOINT_ROOT = DITTO_ROOT / "checkpoints"

# Use PyTorch checkpoints (these exist in your ls)
DATA_ROOT = CHECKPOINT_ROOT / "ditto_pytorch"  # has aux_models + models
CFG_PKL = CHECKPOINT_ROOT / "ditto_cfg" / "v0.4_hubert_cfg_pytorch.pkl"

TMP_DIR = DITTO_ROOT / "tmp"
TMP_DIR.mkdir(parents=True, exist_ok=True)

def run_ditto_inference(audio_path: str, image_path: str) -> str:
    """
    Run Ditto inference.py using your existing checkpoints.

    audio_path, image_path: local filesystem paths
    Returns: local path to generated mp4 inside /tmp/ditto-talkinghead/tmp.
    """
    audio = Path(audio_path)
    image = Path(image_path)

    if not audio.exists():
        raise FileNotFoundError(f"Audio not found: {audio}")
    if not image.exists():
        raise FileNotFoundError(f"Image not found: {image}")
    if not DATA_ROOT.exists():
        raise FileNotFoundError(f"DATA_ROOT not found: {DATA_ROOT}")
    if not CFG_PKL.exists():
        raise FileNotFoundError(f"CFG_PKL not found: {CFG_PKL}")

    out_path = TMP_DIR / f"result_{uuid.uuid4().hex}.mp4"

    cmd = [
        "python", str(DITTO_ROOT / "inference.py"),
        "--dataroot", str(DATA_ROOT),
        "--cfg_pkl", str(CFG_PKL),
        "--audio_path", str(audio),
        "--source_path", str(image),
        "--output_path", str(out_path),
    ]

    env = os.environ.copy()

    proc = subprocess.run(
        cmd,
        cwd=str(DITTO_ROOT),
        env=env,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        timeout=900,
    )

    if proc.returncode != 0:
        raise RuntimeError(f"Inference failed:\n{proc.stdout}")



test_audio = "/Volumes/lab37_catalog/ifstrolley/trolley/Thank you for bookin (1).wav"
test_image = "/Volumes/lab37_catalog/ifstrolley/trolley/new.png"

out = run_ditto_inference(test_audio, test_image)
print("Output video:", out)


    if not out_path.exists():
        raise RuntimeError("Output video not created")

    return str(out_path)
