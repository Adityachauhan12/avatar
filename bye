# CELL 3: Download PyTorch Checkpoints
print("=" * 60)
print("üì• Downloading PyTorch Checkpoints")
print("=" * 60)

import os
from huggingface_hub import snapshot_download

# Create checkpoint directories
CHECKPOINT_DIR = os.path.join(REPO_DIR, "checkpoints")
PYTORCH_CHECKPOINT_DIR = os.path.join(CHECKPOINT_DIR, "ditto_pytorch")

os.makedirs(CHECKPOINT_DIR, exist_ok=True)
os.makedirs(PYTORCH_CHECKPOINT_DIR, exist_ok=True)

print(f"üìÅ Checkpoint directory: {CHECKPOINT_DIR}")
print(f"üìÅ PyTorch directory: {PYTORCH_CHECKPOINT_DIR}")

# Download configuration files
print("\n‚¨áÔ∏è  Downloading configuration files...")
try:
    snapshot_download(
        repo_id="digital-avatar/ditto-talkinghead",
        local_dir=CHECKPOINT_DIR,
        allow_patterns=["ditto_cfg/*"],
        cache_dir=CHECKPOINT_DIR,
        local_dir_use_symlinks=False
    )
    print("‚úÖ Config files downloaded")
except Exception as e:
    print(f"‚ö†Ô∏è Could not download config: {e}")

# Download PyTorch checkpoints
print("\n‚¨áÔ∏è  Downloading PyTorch checkpoints...")
try:
    # First try to get from HuggingFace
    snapshot_download(
        repo_id="digital-avatar/ditto-talkinghead",
        local_dir=PYTORCH_CHECKPOINT_DIR,
        allow_patterns=["ditto_pytorch/*"],
        cache_dir=PYTORCH_CHECKPOINT_DIR,
        local_dir_use_symlinks=False
    )
    print("‚úÖ PyTorch checkpoints downloaded from HuggingFace")
    
    # List downloaded files
    pytorch_files = os.listdir(PYTORCH_CHECKPOINT_DIR)
    print(f"   Found {len(pytorch_files)} files")
    if pytorch_files:
        print("   Sample files:", pytorch_files[:5])
        
except Exception as e:
    print(f"‚ö†Ô∏è Could not download PyTorch checkpoints: {e}")
    print("   Will try to use alternative source...")
    
    # Alternative: Check if we have checkpoints in DBFS
    DBFS_CHECKPOINT = "/dbfs/FileStore/ditto_checkpoints/ditto_pytorch"
    if os.path.exists(DBFS_CHECKPOINT):
        print(f"‚úÖ Found checkpoints in DBFS: {DBFS_CHECKPOINT}")
        # Copy to local directory
        for item in os.listdir(DBFS_CHECKPOINT):
            src = os.path.join(DBFS_CHECKPOINT, item)
            dst = os.path.join(PYTORCH_CHECKPOINT_DIR, item)
            if os.path.isfile(src):
                shutil.copy2(src, dst)
                print(f"   Copied: {item}")
    else:
        print("‚ùå No PyTorch checkpoints found!")
        print("   You may need to download them manually from:")
        print("   https://huggingface.co/digital-avatar/ditto-talkinghead/tree/main/ditto_pytorch")

# Verify we have the PyTorch config
PYTORCH_CONFIG = os.path.join(CHECKPOINT_DIR, "ditto_cfg", "v0.4_hubert_cfg_pytorch.pkl")
if os.path.exists(PYTORCH_CONFIG):
    print(f"\n‚úÖ PyTorch config found: {PYTORCH_CONFIG}")
    print(f"   Size: {os.path.getsize(PYTORCH_CONFIG) / 1024:.1f} KB")
else:
    print(f"\n‚ùå PyTorch config NOT found: {PYTORCH_CONFIG}")
    print("   Will try to use TensorRT config as fallback (may fail)")

print(f"\nüìä Checkpoint summary:")
print(f"   - Config directory: {os.path.join(CHECKPOINT_DIR, 'ditto_cfg')}")
print(f"   - PyTorch checkpoints: {PYTORCH_CHECKPOINT_DIR}")
print(f"   - Total files: {len(os.listdir(PYTORCH_CHECKPOINT_DIR))}")
