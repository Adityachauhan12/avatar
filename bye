import os, site, glob, subprocess, sys

print("ðŸ”§ Fixing LD_LIBRARY_PATH so TensorRT can load libcublas.so.12 ...")

# 1) Find libcublas.so.12 from pip-installed NVIDIA cuBLAS package
cublas_candidates = []
for sp in site.getsitepackages():
    cublas_candidates += glob.glob(os.path.join(sp, "nvidia", "cublas", "lib", "libcublas.so.12*"))

if not cublas_candidates:
    raise RuntimeError("Could not find libcublas.so.12 under site-packages/nvidia/cublas/lib")

cublas_lib_dir = os.path.dirname(cublas_candidates[0])
print("âœ… Found libcublas at:", cublas_candidates[0])

# 2) Find TensorRT libs from tensorrt-libs package
try:
    import tensorrt_libs
    trt_lib_dir = os.path.dirname(tensorrt_libs.__file__)
    print("âœ… Found tensorrt_libs at:", trt_lib_dir)
except Exception as e:
    raise RuntimeError(f"Could not import tensorrt_libs: {e}")

# 3) Export LD_LIBRARY_PATH for this notebook process + subprocesses
os.environ["LD_LIBRARY_PATH"] = (
    f"{cublas_lib_dir}:{trt_lib_dir}:/usr/local/cuda/lib64:"
    + os.environ.get("LD_LIBRARY_PATH", "")
)

print("LD_LIBRARY_PATH =", os.environ["LD_LIBRARY_PATH"])

# 4) Hard validation: can the dynamic loader see libcublas + can python import tensorrt?
subprocess.check_call(["bash", "-lc", "ldconfig -p | grep -E 'libcublas.so.12|libnvinfer.so' | head -n 20 || true"])

print("\nðŸ§ª Testing import tensorrt ...")
import tensorrt as trt
print("âœ… TensorRT import OK. Version =", trt.__version__)






import os, shutil, sys, subprocess

os.chdir("/tmp/ditto-build-8.6")

onnx_dir = "./checkpoints/ditto_onnx"
trt_dir  = "./checkpoints/ditto_trt_custom"

# Clean output dir completely
if os.path.exists(trt_dir):
    shutil.rmtree(trt_dir)
os.makedirs(trt_dir, exist_ok=True)

print("ðŸ“‚ CWD:", os.getcwd())
print("ONNX dir:", onnx_dir)
print("TRT  dir:", trt_dir)

cmd = [sys.executable, "scripts/cvt_onnx_to_trt.py", "--onnx_dir", onnx_dir, "--trt_dir", trt_dir]
print("Running:", " ".join(cmd))

subprocess.check_call(cmd)
print("âœ… Rebuild finished")
