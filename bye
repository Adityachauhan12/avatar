path = '/dbfs/FileStore/VideoReTalking/inference.py'

with open(path, 'r') as f:
    lines = f.readlines()

new_lines = []
for i, line in enumerate(lines):
    if 'mouse_mask = np.zeros_like(restored_img)' in line:
        indent = ' ' * (len(line) - len(line.lstrip()))
        new_lines.append(f"{indent}# GFPGAN disabled: use original image if no restored_img\n")
        new_lines.append(f"{indent}if 'restored_img' in locals():\n")
        new_lines.append(f"{indent}    base_img = restored_img\n")
        new_lines.append(f"{indent}else:\n")
        new_lines.append(f"{indent}    base_img = img_original\n")
        new_lines.append(f"{indent}mouse_mask = np.zeros_like(base_img)\n")
    elif 'restored_img' in line and 'mouse_mask' not in line:
        # Comment out any other direct uses of restored_img
        indent = ' ' * (len(line) - len(line.lstrip()))
        new_lines.append(indent + '# ' + line.lstrip())
    else:
        new_lines.append(line)

with open(path, 'w') as f:
    f.writelines(new_lines)

print("âœ… Patched inference.py to not require restored_img when GFPGAN is disabled")
