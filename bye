import os
import subprocess
import tempfile
from pathlib import Path

class DittoInferenceWrapper:
    """Wrapper to call your existing inference.py"""
    
    def __init__(self, checkpoint_dir, config_pkl):
        self.checkpoint_dir = checkpoint_dir
        self.config_pkl = config_pkl
        print(f"‚úÖ Wrapper initialized")
        print(f"   Checkpoint: {checkpoint_dir}")
        print(f"   Config: {config_pkl}")
        
    def generate_video(self, image_path: str, audio_path: str, 
                       num_frames: int = 50, 
                       face_scale: float = 2.3) -> str:
        """
        Run your inference.py with the provided inputs
        Returns: path to output MP4 file
        """
        
        # Create temp output directory
        output_dir = tempfile.mkdtemp()
        output_path = os.path.join(output_dir, "output.mp4")
        
        # Build your inference command (matching your working notebook)
        cmd = [
            "python", "inference.py",
            "--data_root", self.checkpoint_dir,
            "--cfg_pkl", self.config_pkl,
            "--audio_path", audio_path,
            "--source_path", image_path,
            "--output_path", output_path,
            "--num_frames", str(num_frames),
            "--face_scale", str(face_scale),
        ]
        
        print("üîÑ Running inference command...")
        print("   ", " ".join(cmd))
        result = subprocess.run(cmd, capture_output=True, text=True)
        
        if result.returncode != 0:
            print("‚ùå Error stdout:\n", result.stdout)
            print("‚ùå Error stderr:\n", result.stderr)
            raise RuntimeError(f"Inference failed: {result.stderr}")
        
        print(f"‚úÖ Video generated at: {output_path}")
        return output_path

# ‚úÖ UPDATED WITH YOUR ACTUAL PATHS
wrapper = DittoInferenceWrapper(
    checkpoint_dir="/dbfs/FileStore/ditto_checkpoints/ditto_trt_t4",
    config_pkl="./checkpoints/ditto_cfg/v0.4_hubert_cfg_trt.pkl",
)

print("\n‚úÖ Inference wrapper ready!")
