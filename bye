# CELL 5: Log & Register Model (PACKAGES GIT)
import mlflow
from mlflow.models.signature import infer_signature
import pandas as pd
import git  # ‚Üê FORCE IMPORT HERE

mlflow.set_registry_uri("databricks-uc")
mlflow.set_experiment("/Shared/ditto_experiment")

# Test input/output
test_input = pd.DataFrame({
    "audio_path": ["/dbfs/test.wav"],
    "image_path": ["/dbfs/test.png"]
})

test_output = pd.DataFrame({
    "status": ["success"],
    "message": ["Video generated"],
    "video_path": ["/tmp/output.mp4"]
})

signature = infer_signature(test_input, test_output)

print("üì¶ Packaging model with git...")

with mlflow.start_run():
    mlflow.pyfunc.log_model(
        artifact_path="ditto_talking_head",
        python_model=DittoTalkingHeadModel(),
        signature=signature,
        pip_requirements=["gitpython==3.1.40"],  # ‚Üê PACKAGES GIT
        conda_env=None
    )
    run_id = mlflow.active_run().info.run_id

print(f"‚úÖ New run ID: {run_id}")

# Register
model_version = mlflow.register_model(
    model_uri=f"runs:/{run_id}/ditto_talking_head",
    name="lab37_catalog.ifstrolley.ditto_talkinghead"
)

print(f"‚úÖ NEW VERSION: {model_version.version}")
