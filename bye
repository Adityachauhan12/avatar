# CELL 5: Log Model with Conda Environment (CORRECT VERSION)

import subprocess
import sys

# First, install PyYAML
print("üì¶ Installing PyYAML...")
subprocess.check_call([sys.executable, "-m", "pip", "install", "-q", "pyyaml"])
print("‚úÖ PyYAML installed\n")

import mlflow
from mlflow.models.signature import infer_signature
import pandas as pd
import yaml
import tempfile
import os

mlflow.set_registry_uri("databricks-uc")
mlflow.set_experiment("/Shared/ditto_experiment")

print("üìã Defining model signature...")

# Define Signature
test_input = pd.DataFrame({
    "audio_b64": ["UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="],
    "image_b64": ["iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII="]
})

test_output = pd.DataFrame({
    "status": ["success"],
    "message": ["Video generated"],
    "video_b64": ["AAAAIGZ0eXBpc29tAAACAgAAAABpc29tcGF2YzFtcDQyAAAAAAA..."]
})

signature = infer_signature(test_input, test_output)
print("‚úÖ Signature defined\n")

print("üì¶ Creating conda.yaml with NVIDIA Index...")

# Create conda environment file with NVIDIA index properly configured
conda_env = {
    "name": "ditto-env",
    "channels": ["conda-forge", "defaults"],
    "dependencies": [
        "python=3.10",
        "pip",
        {
            "pip": [
                "--extra-index-url https://pypi.nvidia.com",
                "tensorrt==8.6.1",
                "tensorrt-libs==8.6.1",
                "tensorrt-bindings==8.6.1",
                "cuda-python==12.2.0",
                "onnxruntime-gpu==1.16.3",
                "numpy==1.26.4",
                "gitpython==3.1.40",
                "librosa>=0.10.1",
                "imageio-ffmpeg",
                "opencv-python-headless",
                "soundfile",
                "soxr",
                "imageio",
                "moviepy",
                "mediapipe>=0.10.9",
                "ml_dtypes==0.4.0",
                "einops",
                "omegaconf",
                "huggingface_hub",
                "filetype",
                "tqdm",
                "scikit-image",
                "colored",
                "polygraphy",
                "mlflow==3.8.1"
            ]
        }
    ]
}

# Write to temp file
conda_file = tempfile.NamedTemporaryFile(mode='w', suffix='.yaml', delete=False)
yaml.dump(conda_env, conda_file)
conda_file.close()
conda_file_path = conda_file.name

print(f"‚úÖ Conda environment file created: {conda_file_path}")
print("\nüìã Conda.yaml Contents (First 30 lines):")
with open(conda_file_path, 'r') as f:
    lines = f.readlines()
    for line in lines[:30]:
        print(line.rstrip())

print("\n" + "="*60)
print("üöÄ Logging model to MLflow...")
print("="*60 + "\n")

with mlflow.start_run() as run:
    mlflow.pyfunc.log_model(
        artifact_path="ditto_talking_head",
        python_model=DittoTalkingHeadModel(),  # Uses the class from CELL 4
        signature=signature,
        conda_env=conda_file_path,  # ‚úÖ USE CONDA ENV (NOT pip_requirements)
        pip_requirements=None
    )
    run_id = run.info.run_id

print(f"‚úÖ Model Logged. Run ID: {run_id}\n")

# Register to Unity Catalog
uc_model_name = "lab37_catalog.ifstrolley.ditto_talkinghead"
print(f"üìù Registering to {uc_model_name}...")

try:
    model_version = mlflow.register_model(
        model_uri=f"runs:/{run_id}/ditto_talking_head",
        name=uc_model_name
    )
    print(f"‚úÖ SUCCESS! Registered Version: {model_version.version}")
    print(f"\n" + "="*60)
    print(f"üëâ NEXT STEPS:")
    print(f"="*60)
    print(f"1. Go to: Serving ‚Üí ditto_with_base64")
    print(f"2. Click 'Update' or 'Create New'")
    print(f"3. Select Version: {model_version.version}")
    print(f"4. Set Workload: GPU_SMALL")
    print(f"5. Click DEPLOY")
    print(f"6. ‚è≥ Wait 15 minutes for READY status")
    print(f"="*60 + "\n")
    
except Exception as e:
    print(f"‚ùå Registration Error: {e}")
    import traceback
    traceback.print_exc()

# Cleanup temp file
try:
    os.unlink(conda_file_path)
    print("üßπ Cleaned up temporary files")
except:
    pass
