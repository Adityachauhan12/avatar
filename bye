%sh
apt-get update
apt-get install -y git-lfs ffmpeg






%pip install \
  librosa tqdm filetype imageio opencv-python-headless scikit-image \
  imageio-ffmpeg colored \
  soundfile mediapipe onnxruntime-gpu \
  omegaconf einops ml-dtypes \
  tensorflow==2.14.1 \
  torch==2.0.1 torchvision==0.15.2 \
  tensorrt==8.6.1

dbutils.library.restartPython()







%sh
rm -rf /tmp/ditto-talkinghead
git clone https://github.com/antgroup/ditto-talkinghead /tmp/ditto-talkinghead

cd /tmp/ditto-talkinghead
mkdir -p checkpoints
git clone https://huggingface.co/digital-avatar/ditto-talkinghead checkpoints






from pathlib import Path
import os
import tempfile  # <-- yeh add karo

DITTO_ROOT = Path("/tmp/ditto-talkinghead")

# PyTorch model ke hisaab se (Ditto docs se) [attached_file:1]
DATA_ROOT = DITTO_ROOT / "checkpoints" / "ditto_pytorch"
CFG_PKL = DITTO_ROOT / "checkpoints" / "ditto_cfg" / "v0.4_hubert_cfg_pytorch.pkl"

TMP_DIR = Path(tempfile.gettempdir()) / "ditto_tmp"
TMP_DIR.mkdir(exist_ok=True)

print("‚úÖ Paths ready:")
print(f"DITTO_ROOT: {DITTO_ROOT}")
print(f"DATA_ROOT: {DATA_ROOT}")
print(f"CFG_PKL: {CFG_PKL}")

assert DITTO_ROOT.exists(), "Repo missing"
assert DATA_ROOT.exists(), "Data root missing"
assert CFG_PKL.exists(), "CFG PKL missing"
print("üéâ All paths verified!")










import subprocess
import uuid
import tempfile
import shutil

def run_ditto_inference(audio, image):
    """
    EXACT same function from your notebook [file:31]
    """
    # File validation
    audio = Path(audio)
    image = Path(image)
    
    if not audio.exists():
        raise FileNotFoundError(f"Audio not found: {audio}")
    if not image.exists():
        raise FileNotFoundError(f"Image not found: {image}")
    if not DATA_ROOT.exists():
        raise FileNotFoundError(f"DATA_ROOT not found: {DATA_ROOT}")
    if not CFG_PKL.exists():
        raise FileNotFoundError(f"CFG_PKL not found: {CFG_PKL}")

    out_path = TMP_DIR / f"result_{uuid.uuid4().hex}.mp4"

    cmd = [
        "python", str(DITTO_ROOT / "inference.py"),
        "--data_root", str(DATA_ROOT),  # underscore here [file:31]
        "--cfg_pkl", str(CFG_PKL),
        "--audio_path", str(audio),
        "--source_path", str(image),
        "--output_path", str(out_path),
    ]

    env = os.environ.copy()

    proc = subprocess.run(
        cmd,
        cwd=str(DITTO_ROOT),
        env=env,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        timeout=900,
    )

    if proc.returncode != 0:
        raise RuntimeError(f"Inference failed:\n{proc.stdout}")

    if not out_path.exists():
        raise RuntimeError("Output video not created")

    return str(out_path)








TEST_AUDIO = "/dbfs/FileStore/avatar_test/Thank_you_audio.wav"
TEST_IMAGE = "/dbfs/FileStore/avatar_test/new.png"

print("üß™ Testing with real files:")
print(f"Audio: {TEST_AUDIO}")
print(f"Image: {TEST_IMAGE}")

# Verify files exist
assert Path(TEST_AUDIO).exists(), "Audio missing in DBFS"
assert Path(TEST_IMAGE).exists(), "Image missing in DBFS"
print("‚úÖ Files ready!")

# Run inference (Docker ke exact flow)
try:
    output_path = run_ditto_inference(TEST_AUDIO, TEST_IMAGE)
    print(f"üéâ SUCCESS! Output: {output_path}")
    print(f"Size: {Path(output_path).stat().st_size:,} bytes")
except Exception as e:
    print(f"‚ùå FAILED: {e}")
    import traceback
    traceback.print_exc()









if 'output_path' in locals() and Path(output_path).exists():
    dbfs_results = Path("/dbfs/FileStore/avatar_test_results")
    dbfs_results.mkdir(parents=True, exist_ok=True)
    final_path = dbfs_results / "backend_test_result.mp4"
    
    shutil.copy2(output_path, final_path)
    
    displayHTML(f"""
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                color: white; padding: 25px; border-radius: 15px; text-align: center;">
        <h2>üéâ Backend Test PASSED!</h2>
        <p><strong>Video ready for Docker deployment</strong></p>
        <a href="/files/avatar_test_results/backend_test_result.mp4" 
           download style="background: white; color: #667eea; 
                          padding: 12px 30px; text-decoration: none; 
                          border-radius: 25px; font-weight: bold; font-size: 16px;">
            üì• Download MP4
        </a>
        <br><br>
        <small>RC: 0 | Size: {Path(output_path).stat().st_size:,} bytes</small>
    </div>
    """)
else:
    displayHTML("""
    <div style="background: #ffebee; color: #c62828; padding: 20px; border-radius: 10px;">
        <h3>‚ùå Backend test failed</h3>
        <p>Fix inference.py call before Docker deployment</p>
    </div>
    """)










# Cell: Copy files to DBFS
from pathlib import Path
import shutil

# Source paths (tere local)
src_audio = Path("/Volumes/lab37_catalog/ifstrolley/trolley/Thank you for bookin (1).wav")
src_image = Path("/Volumes/lab37_catalog/ifstrolley/trolley/new.png")

# DBFS target
dbfs_audio = Path("/dbfs/FileStore/avatar_test/Thank_you_audio.wav")
dbfs_image = Path("/dbfs/FileStore/avatar_test/new.png")

# Create dir
Path("/dbfs/FileStore/avatar_test").mkdir(parents=True, exist_ok=True)

# Copy
shutil.copy2(src_audio, dbfs_audio)
shutil.copy2(src_image, dbfs_image)

print("‚úÖ Copied to DBFS:")
print(f"Audio: {dbfs_audio}")
print(f"Image: {dbfs_image}")
