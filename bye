import subprocess
from pathlib import Path
import uuid
import tempfile
import os

# Base repo path (you already cd here in the notebook)
DITTO_ROOT = Path("/tmp/ditto-talkinghead")
CHECKPOINT_ROOT = DITTO_ROOT / "checkpoints"

# Use PyTorch checkpoints (these exist in your ls)
DATA_ROOT = CHECKPOINT_ROOT / "ditto_pytorch"  # has aux_models + models
CFG_PKL = CHECKPOINT_ROOT / "ditto_cfg" / "v0.4_hubert_cfg_pytorch.pkl"

TMP_DIR = DITTO_ROOT / "tmp"
TMP_DIR.mkdir(parents=True, exist_ok=True)

def run_ditto_inference(audio_path: str, image_path: str) -> str:
    """
    Run Ditto inference.py using your existing checkpoints.

    audio_path, image_path: local filesystem paths
    Returns: local path to generated mp4 inside /tmp/ditto-talkinghead/tmp.
    """
    audio = Path(audio_path)
    image = Path(image_path)

    if not audio.exists():
        raise FileNotFoundError(f"Audio not found: {audio}")
    if not image.exists():
        raise FileNotFoundError(f"Image not found: {image}")
    if not DATA_ROOT.exists():
        raise FileNotFoundError(f"DATA_ROOT not found: {DATA_ROOT}")
    if not CFG_PKL.exists():
        raise FileNotFoundError(f"CFG_PKL not found: {CFG_PKL}")

    out_path = TMP_DIR / f"result_{uuid.uuid4().hex}.mp4"

    cmd = [
        "python", str(DITTO_ROOT / "inference.py"),
        "--dataroot", str(DATA_ROOT),
        "--cfg_pkl", str(CFG_PKL),
        "--audio_path", str(audio),
        "--source_path", str(image),
        "--output_path", str(out_path),
    ]

    env = os.environ.copy()

    proc = subprocess.run(
        cmd,
        cwd=str(DITTO_ROOT),
        env=env,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        timeout=900,
    )

    if proc.returncode != 0:
        raise RuntimeError(f"Inference failed:\n{proc.stdout}")

    if not out_path.exists():
        raise RuntimeError("Output video not created")

    return str(out_path)



from fastapi import FastAPI, UploadFile, File, HTTPException
from fastapi.responses import FileResponse
from pathlib import Path
import shutil
import uuid
import tempfile

from ditto_inference_wrapper import run_ditto_inference  # from cell 1

app = FastAPI(title="Ditto Avatar API (Databricks)")

UPLOAD_DIR = Path(tempfile.gettempdir()) / "ditto_uploads"
UPLOAD_DIR.mkdir(parents=True, exist_ok=True)

@app.get("/health")
def health():
    return {"status": "ok", "env": "databricks-notebook"}

@app.post("/generate-avatar")
async def generate_avatar(
    audio: UploadFile = File(...),
    image: UploadFile = File(...),
):
    if not audio.filename.lower().endswith((".wav", ".mp3")):
        raise HTTPException(status_code=400, detail="audio must be .wav or .mp3")
    if not image.filename.lower().endswith((".png", ".jpg", ".jpeg")):
        raise HTTPException(status_code=400, detail="image must be .png/.jpg/.jpeg")

    audio_path = UPLOAD_DIR / f"{uuid.uuid4().hex}_{audio.filename}"
    image_path = UPLOAD_DIR / f"{uuid.uuid4().hex}_{image.filename}"

    try:
        with audio_path.open("wb") as f:
            shutil.copyfileobj(audio.file, f)
        with image_path.open("wb") as f:
            shutil.copyfileobj(image.file, f)

        out_path = run_ditto_inference(str(audio_path), str(image_path))

        return FileResponse(
            path=out_path,
            media_type="video/mp4",
            filename="avatar.mp4",
        )

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Inference error: {e}")

    finally:
        if audio_path.exists():
            audio_path.unlink(missing_ok=True)
        if image_path.exists():
            image_path.unlink(missing_ok=True)
